#!/usr/bin/env bash

export DISPLAY=":0.0"

WALLPAPERS_PATH="${1:-/home/$USER/wallpapers/single/CatppuccinMockaPopurri}"
CONFIG_FILE="$HOME/.config/nitrogen/bg-saved.cfg"

# Get number of active monitors (have a resolution displayed)
NUM_MONITORS=$(xrandr --query | grep -E "^\S+ connected" | grep -cE "[0-9]+x[0-9]+\+[0-9]+\+[0-9]+")

# Update each monitor's wallpaper
for ((idx=0; idx<NUM_MONITORS; idx++)); do
    # Pick a random wallpaper
    WP=$(find "$WALLPAPERS_PATH" -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" \) | shuf -n 1)

    # Update the corresponding xin_N entry in config (preserving mode)
    sed -i "/^\[xin_$idx\]/,/^\[/{s|^file=.*|file=$WP|}" "$CONFIG_FILE"
done

# Restore wallpapers from updated config
nitrogen --restore
