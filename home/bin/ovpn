#!/bin/bash

PROFILES_DIR="$HOME/.config/openvpn/profiles"
CREDS_DIR="$HOME/.config/openvpn/credentials"

declare -A VPNS
# format: "config:ping_host:creds_file:key_file:otp_type"
# otp_type: yubikey (append to password), challenge (manual entry), empty (none)
VPNS=(
    ["LG"]="lg.ovpn:ehr-01.stage.int.aws.lillegroup.com:lg.txt::yubikey"
    ["CCA"]="cca.ovpn:172.22.20.150:cca.txt::challenge"
    ["Home"]="home.ovpn:192.168.50.244::"
    ["Daten"]="daten.ovpn:10.196.33.178:daten.txt:daten-key.txt:"
)

case "$1" in
--connect)
    VPN="$2"
    if [[ -z "$VPN" ]]; then
        VPN=$(printf "%s\n" "${!VPNS[@]}" | sort | fzf --prompt="Select VPN: ")
    fi
    [[ -z "$VPN" || -z "${VPNS[$VPN]}" ]] && echo "‚ùå Invalid VPN" && exit 1

    IFS=':' read -ra DATA <<< "${VPNS[$VPN]}"
    CONF="${DATA[0]}"
    CREDS="${DATA[2]}"
    KEY="${DATA[3]}"
    OTP_TYPE="${DATA[4]}"

    CREDS_FILE="$CREDS_DIR/$CREDS"
    CLEANUP_CREDS=false

    # Handle YubiKey OTP - prompt and append to password in temp file
    if [[ "$OTP_TYPE" == "yubikey" && -n "$CREDS" && -f "$CREDS_DIR/$CREDS" ]]; then
        read -rsp "üîë YubiKey OTP: " OTP
        echo
        USERNAME=$(head -1 "$CREDS_DIR/$CREDS")
        PASSWORD=$(tail -1 "$CREDS_DIR/$CREDS")
        CREDS_FILE="/tmp/ovpn_creds_$$.txt"
        printf "%s\n%s%s\n" "$USERNAME" "$PASSWORD" "$OTP" > "$CREDS_FILE"
        chmod 600 "$CREDS_FILE"
        CLEANUP_CREDS=true
    fi

    CMD="sudo openvpn --config $PROFILES_DIR/$CONF --daemon --log /tmp/openvpn-$VPN.log"
    [[ -n "$CREDS" && -f "$CREDS_FILE" ]] && CMD="$CMD --auth-user-pass $CREDS_FILE"
    [[ -n "$KEY" && -f "$CREDS_DIR/$KEY" ]] && CMD="$CMD --askpass $CREDS_DIR/$KEY"

    # Clean stale VPN routes before connecting
    sudo ip route del 10.129.0.128/27 2>/dev/null
    sudo ip route del 172.18.10.0/24 2>/dev/null
    sudo ip route del 172.18.128.0/24 2>/dev/null
    sudo ip route del 10.128.0.0/16 2>/dev/null
    sudo ip route del 10.130.0.0/15 2>/dev/null

    echo "üîå Connecting to $VPN..."
    eval $CMD

    # Cleanup temp credentials after connection starts
    if $CLEANUP_CREDS; then
        sleep 2
        rm -f "$CREDS_FILE"
    fi

    echo "üìÑ Logs: tail -f /tmp/openvpn-$VPN.log"
    ;;
--disconnect)
    echo "üî• Disconnecting..."
    sudo killall openvpn 2>/dev/null
    ;;
--active)
    for KEY in "${!VPNS[@]}"; do
        IFS=':' read -ra DATA <<< "${VPNS[$KEY]}"
        if pgrep -f "${DATA[0]}" >/dev/null && ping -c1 -W2 "${DATA[1]}" >/dev/null 2>&1; then
            echo "$KEY"
        fi
    done
    ;;
--logs)
    VPN="$2"
    tail -f /tmp/openvpn-${VPN:-*}.log
    ;;
--setup)
    mkdir -p "$CREDS_DIR"
    chmod 700 "$CREDS_DIR"
    echo "Create credential files in: $CREDS_DIR"
    echo "Format: username on line 1, password on line 2"
    ;;
*)
    echo "Usage: ovpn --connect [VPN] | --disconnect | --active | --logs [VPN] | --setup"
    echo "VPNs: ${!VPNS[@]}"
    ;;
esac
