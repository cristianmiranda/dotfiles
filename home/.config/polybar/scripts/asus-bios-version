#!/bin/bash

url="https://rog.asus.com/support/webapi/product/GetPDBIOS?website=global&model=rog-maximus-z790-hero&pdid=0&m1id=21116&cpu=&LevelTagId=205902&systemCode=rog"

response=$(curl -s --max-time 10 "$url" 2>/dev/null)

# Check if curl failed or returned empty response
if [ $? -ne 0 ] || [ -z "$response" ]; then
    echo "---"
    exit 0
fi

clean_response=$(echo "$response" | tr -d '\n' | tr -d '\r' | tr -d '\t' | sed 's/[[:cntrl:]]//g')

latest_bios_version=$(echo "$clean_response" | jq -r '.Result.Obj[].Files[0].Version' 2>/dev/null | head -n 1)

# Check if jq parsing failed or returned null
if [ $? -ne 0 ] || [ "$latest_bios_version" = "null" ] || [ -z "$latest_bios_version" ]; then
    echo "---"
    exit 0
fi

current_bios_version=$(cat /sys/class/dmi/id/bios_version)

if [ "$latest_bios_version" != "$current_bios_version" ]; then
  icon="î°™"
  color="#FF6961"
  version="$latest_bios_version"
  echo "%{F$color}$icon v$version%{F-}"
else
  echo ""
fi
