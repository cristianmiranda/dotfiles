#!/bin/bash

LAT="-34.3824546"
LON="-58.881424"
LOCATION="zelaya"
FORMAT="%c%t%20|+%f%20💧%p%20💨%20%w"

# Random number to bypass wttr.in cache
RANDOM_NUMBER=$(shuf -i 1-999999 -n 1)

# Fetch weather
WEATHER_RAW=$(curl -s "https://wttr.in/${LOCATION}?m&lang=es&format=${FORMAT}&random=${RANDOM_NUMBER}")

# Handle errors
if [[ "$WEATHER_RAW" =~ "Unknown" || "$WEATHER_RAW" =~ "Sorry" ]]; then
    echo "🌪️"
    exit 0
fi

# Extract parts based on emojis
ICON_TEMP=$(echo "$WEATHER_RAW" | sed -E 's/(💧.*)//')
PRECIP=$(echo "$WEATHER_RAW" | grep -oE '💧[^💨]+')
WIND=$(echo "$WEATHER_RAW" | grep -oE '💨.*')

# Remove Celsius symbol from temperature but keep degree sign, and shorten wind units
ICON_TEMP=$(echo "$ICON_TEMP" | sed 's/°C/°/g')
WIND=$(echo "$WIND" | sed -e 's/°C/°/g' -e 's/km\/h/kph/g')

# If precipitation is 0mm or 0.0mm, omit it
if [[ "$PRECIP" =~ 💧0(\.0)?mm ]]; then
    echo "${ICON_TEMP}${WIND}"
else
    # Remove Celsius from full output as well but keep degree sign, and shorten wind units
    echo "$WEATHER_RAW" | sed -e 's/°C/°/g' -e 's/km\/h/kph/g'
fi
