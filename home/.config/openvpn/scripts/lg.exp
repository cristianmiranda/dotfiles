#!/usr/bin/expect -f

proc clearAndDisplayTitle {} {
    system "clear"
    puts ""
    system "figlet -d /home/cmiranda/.local/share/figlet -f \"ANSI Shadow\" -c 'VPN' | lolcat"
}

clearAndDisplayTitle
puts "ğŸ”‘ Yubikey OTP:"
expect_user -re "(.*)\n"
set yubi $expect_out(1,string)

clearAndDisplayTitle
puts "ğŸ§ Requesting sudo password..."
set sudopass [exec /home/cmiranda/bin/1p sudo-password]

clearAndDisplayTitle
puts "ğŸŒ Requesting VPN credentials..."
set username [exec /home/cmiranda/bin/1p lg-vpn-username]
set password [exec /home/cmiranda/bin/1p lg-vpn-password]

clearAndDisplayTitle
puts "ğŸ«£ Writing credentials to file..."
set outputFilename "/tmp/vpn_credentials.txt"
set outFileId [open $outputFilename "w"]
puts -nonewline $outFileId "$username\n"
puts -nonewline $outFileId "$password"
puts -nonewline $outFileId "$yubi\n"
close $outFileId

spawn sudo openvpn --daemon --config /home/cmiranda/.config/openvpn/profiles/lg.ovpn --auth-user-pass /tmp/vpn_credentials.txt
expect "password for cmiranda:"
send "$sudopass\r"

clearAndDisplayTitle
puts "ğŸ›œ Connecting to VPN..."

sleep 5
clearAndDisplayTitle
puts "ğŸ—‘ Removing credentials file..."
system "rm $outputFilename"

# Hand over control to user
interact
